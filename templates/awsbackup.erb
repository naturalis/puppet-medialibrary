#!/bin/bash
#
#

# backup 

PIDFILE=/var/run/awsbackup.pid

if [ -e "$PIDFILE" ] ; then
    # our pidfile exists, let's make sure the process is still running though
    PID=`/bin/cat "$PIDFILE"`
    if /bin/kill -0 "$PID" > /dev/null 2>&1 ; then
        exit 0
    fi
 fi

# create or update the pidfile
/bin/echo "$$" > $PIDFILE

echo "$(date '+%Y-%m-%d %H:%M:%S') -- aws sync started" >> /var/log/aws/s3backup.log
/usr/local/bin/aws s3 sync /data s3://<%= @aws_bucket %> --no-progress 2>&1 >> /var/log/aws/s3backup.log

if [ $? = "1" ] ; then
   echo "$(date '+%Y-%m-%d %H:%M:%S') -- aws sync failed" >> /var/log/aws/s3backup.log
   cleanup
 exit 1
fi
echo "$(date '+%Y-%m-%d %H:%M:%S') -- aws sync succeeded" >> /var/log/aws/s3backup.log



# remove PIDfile
/bin/rm -f "$PIDFILE"

